<!DOCTYPE html>
<html>
  <head>
    <title>Control de Temperatura y Motores</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      button,
      input {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      .output {
        font-size: 18px;
      }
      .motor-control {
        margin-top: 30px;
      }
      .motor {
        margin: 10px;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Control de Temperatura y Motores</h1>
    <div class="container">
      <!-- Control de temperatura -->
      <div>
        <h3>Actualizar Temperatura en Celsius</h3>
        <input type="number" id="setpoint" placeholder="Temperatura en °C" />
        <button onclick="updateSetpoint()">Actualizar</button>
      </div>
      <div class="output" id="temperature-display">Temperatura actual: ---</div>

      <!-- Control de motores -->
      <div class="motor-control">
        <h2>Control de Motores</h2>
        <div class="motor" id="motor1">
          <h3>Motor 1</h3>
          <input type="range" id="motor1-power" min="0" max="100" value="0" />
          <span id="motor1-power-display">Potencia: 0%</span>
          <br />
          <button onclick="toggleMotor('motor_1')">Encender/Apagar</button>
          <button onclick="updateMotor('motor_1')">Actualizar Potencia</button>
        </div>
        <div class="motor" id="motor2">
          <h3>Motor 2</h3>
          <input type="range" id="motor2-power" min="0" max="100" value="0" />
          <span id="motor2-power-display">Potencia: 0%</span>
          <br />
          <button onclick="toggleMotor('motor_2')">Encender/Apagar</button>
          <button onclick="updateMotor('motor_2')">Actualizar Potencia</button>
        </div>
      </div>
    </div>
    <script>
      // Función para actualizar el setpoint
      function updateSetpoint() {
        const data = {
          action: "update_setpoint",
          value: document.getElementById("setpoint").value,
        };
        fetch(window.location.href, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.message) {
              alert(data.message);
            }
          })
          .catch(() => alert("Error al actualizar el setpoint"));
      }

      // Función para actualizar la temperatura automáticamente
      function updateTemperature() {
        fetch(window.location.href + "temperature", {
          method: "GET",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.temperature) {
              document.getElementById(
                "temperature-display"
              ).innerText = `Temperatura actual: ${data.temperature.toFixed(
                2
              )}°C`;
            }
          })
          .catch(() => {
            document.getElementById("temperature-display").innerText =
              "Error obteniendo temperatura.";
          });
      }

      // Función para encender/apagar un motor
      function toggleMotor(motor) {
        const state = confirm(`¿Deseas cambiar el estado de ${motor}?`);
        fetch(window.location.href, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "set_motor",
            motor: motor,
            state: state,
          }),
        })
          .then((response) => response.json())
          .then((data) => alert(data.message))
          .catch(() => alert("Error cambiando estado del motor"));
      }

      // Función para actualizar la potencia de un motor
      function updateMotor(motor) {
        const power = document.getElementById(`${motor}-power`).value;
        fetch(window.location.href, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "set_motor",
            motor: motor,
            power: power,
          }),
        })
          .then((response) => response.json())
          .then((data) => alert(data.message))
          .catch(() => alert("Error actualizando potencia del motor"));
      }

      // Actualiza la visualización de potencia en tiempo real
      document.getElementById("motor1-power").addEventListener("input", (e) => {
        document.getElementById(
          "motor1-power-display"
        ).innerText = `Potencia: ${e.target.value}%`;
      });
      document.getElementById("motor2-power").addEventListener("input", (e) => {
        document.getElementById(
          "motor2-power-display"
        ).innerText = `Potencia: ${e.target.value}%`;
      });

      // Actualiza la temperatura cada 5 segundos
      setInterval(updateTemperature, 5000);
      // Llama a la función al cargar la página
      updateTemperature();
    </script>
  </body>
</html>
